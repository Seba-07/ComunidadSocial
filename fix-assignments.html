<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fix Assignments</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; }
        .result { margin-top: 20px; padding: 15px; border-radius: 8px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <h1>üîß Reparar Asignaciones de Ministros</h1>
    <p>Este script sincronizar√° las asignaciones de ministros con los IDs correctos.</p>
    <button onclick="fixAssignments()">Reparar Asignaciones</button>
    <div id="result"></div>

    <script type="module">
        import { ministroService } from './src/services/MinistroService.js';
        import { ministroAssignmentService } from './src/services/MinistroAssignmentService.js';

        window.fixAssignments = function() {
            const ministros = ministroService.getAll();
            const assignments = ministroAssignmentService.getAll();

            console.log('Ministros:', ministros);
            console.log('Assignments:', assignments);

            let fixed = 0;
            let errors = [];

            assignments.forEach(assignment => {
                // Buscar ministro por RUT (m√°s confiable que ID)
                const ministro = ministros.find(m => m.rut === assignment.ministroRut);

                if (ministro) {
                    // Si el ministroId no coincide, actualizarlo
                    if (assignment.ministroId !== ministro.id) {
                        console.log(`Fixing assignment ${assignment.id}: changing ministroId from ${assignment.ministroId} to ${ministro.id}`);
                        
                        try {
                            ministroAssignmentService.update(assignment.id, {
                                ministroId: ministro.id
                            });
                            fixed++;
                        } catch (error) {
                            errors.push(`Error updating ${assignment.id}: ${error.message}`);
                        }
                    }
                } else {
                    errors.push(`No se encontr√≥ ministro con RUT ${assignment.ministroRut} para la asignaci√≥n ${assignment.id}`);
                }
            });

            const result = document.getElementById('result');
            if (fixed > 0 || errors.length > 0) {
                result.className = 'result success';
                result.innerHTML = `
                    <h3>Resultado:</h3>
                    <p>‚úÖ ${fixed} asignaciones reparadas</p>
                    ${errors.length > 0 ? `<p style="color: #dc2626;">‚ùå ${errors.length} errores:</p><ul>${errors.map(e => `<li>${e}</li>`).join('')}</ul>` : ''}
                    <p style="margin-top: 16px;">Ahora puedes <a href="/ministro-login.html">iniciar sesi√≥n como ministro</a> y deber√≠as ver tus asambleas.</p>
                `;
            } else {
                result.className = 'result success';
                result.innerHTML = `
                    <h3>Todo OK!</h3>
                    <p>‚úÖ No se encontraron asignaciones que reparar. Todo est√° sincronizado correctamente.</p>
                `;
            }
        };
    </script>
</body>
</html>
